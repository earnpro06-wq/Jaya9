<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Profile Verification</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            background-color: #111827;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        .modal-box {
            background: #111827;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            border: none;
        }

        .modal-header {
            background: linear-gradient(180deg, #1a1a4d 0%, #0b1120 100%);
            color: #ffcc00;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
            border-bottom: 1px solid #1e293b;
            text-transform: uppercase;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .back-btn {
            font-size: 18px;
            cursor: pointer;
            color: #ffcc00;
            display: none;
        }

        .close-btn {
            font-size: 18px;
            cursor: pointer;
            color: #fff;
        }

        .modal-body {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
        }

        .input-group {
            width: 100%;
            margin-bottom: 10px;
        }

        .input-label {
            display: block;
            font-size: 11px;
            font-weight: bold;
            color: #94a3b8;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .input-label span {
            color: #ff6600;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 1px solid #374151;
            border-radius: 6px;
            outline: none;
            font-size: 14px;
            background-color: #1f2937;
            color: #ffcc00;
        }

        .input-field:focus {
            border-color: #ff6600;
        }

        .captcha-row, .phone-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .captcha-code {
            background: linear-gradient(180deg, #1a1a4d 0%, #0b1120 100%);
            color: #fff;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 16px;
            letter-spacing: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            border: 1px solid #1e293b;
            cursor: pointer;
            min-width: 120px;
            user-select: none;
        }

        .refresh-icon {
            color: #ffcc00;
            font-size: 18px;
            display: inline-block;
        }

        .rotating {
            animation: spin 0.5s linear;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .error-text {
            color: #ff4d4d;
            font-size: 10px;
            margin-top: 4px;
            display: none;
            font-weight: 500;
        }

        .success-text {
            color: #10b981;
            font-size: 10px;
            margin-top: 4px;
            display: none;
            font-weight: 500;
        }

        .readonly-input {
            background-color: #0b1120;
            border: 1px solid #1e293b;
            color: #64748b;
        }

        .otp-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .otp-inputs {
            display: flex;
            justify-content: space-between;
            gap: 5px;
        }

        .otp-box {
            width: 45px;
            height: 50px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            background-color: #1f2937;
            border: 1px solid #374151;
            color: #ffcc00;
            border-radius: 6px;
            outline: none;
        }

        .otp-box:focus {
            border-color: #ff6600;
        }

        .request-otp-btn {
            background-color: #ff6600;
            border: none;
            color: white;
            padding: 12px 10px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 10px;
            cursor: pointer;
            text-transform: uppercase;
            white-space: nowrap;
            min-width: 100px;
            transition: 0.3s;
            height: 45px;
        }

        .request-otp-btn:disabled {
            background-color: #374151;
            cursor: not-allowed;
        }

        .timer-active {
            background-color: #ff8c00 !important;
        }

        .submit-btn {
            width: 100%;
            height: 50px;
            background-color: #ff6600;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 102, 0, 0.3);
            text-transform: uppercase;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .spin-normal {
            animation: spin-icon 2s linear infinite;
        }

        @keyframes spin-icon {
            100% { transform: rotate(360deg); }
        }

        #secondary-number-view {
            display: none;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
        }

        .phone-input-container {
            position: relative;
            display: flex;
            align-items: center;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 6px;
            overflow: hidden;
        }

        .prefix {
            padding-left: 12px;
            color: #94a3b8;
            font-weight: bold;
            font-size: 14px;
            user-select: none;
        }

        .secondary-input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 12px 8px;
            color: #ffcc00;
            font-size: 16px;
            outline: none;
            font-weight: 500;
        }

        .info-notice {
            background: rgba(255, 102, 0, 0.1);
            border: 1px solid rgba(255, 102, 0, 0.2);
            padding: 10px;
            border-radius: 6px;
            font-size: 11px;
            color: #cbd5e1;
            line-height: 1.4;
        }

        @media screen and (max-width: 480px) {
            .otp-box {
                width: 40px;
                height: 45px;
            }
            .request-otp-btn {
                min-width: 90px;
                font-size: 9px;
            }
        }
    </style>
</head>
<body>

    <div class="modal-box">
        <div class="modal-header">
            <div class="header-left">
                <i class="fas fa-arrow-left back-btn" id="header-back" onclick="goToVerificationView()"></i>
                <span id="header-title">Verify Phone Number</span>
            </div>
            <div class="close-btn" onclick="handleManualClose()">✕</div>
        </div>

        <div class="modal-body" id="verification-view">
            
            <div class="input-group">
                <label class="input-label">Verification Code <span>*</span></label>
                <div class="captcha-row">
                    <input type="text" id="captcha-input" class="input-field" placeholder="4-digit code" inputmode="numeric" maxlength="4">
                    <div class="captcha-code" onclick="generateCaptcha()">
                        <div id="captcha-text">....</div>
                        <i id="refresh-icon" class="fas fa-sync-alt refresh-icon"></i>
                    </div>
                </div>
                <p id="captcha-error" class="error-text">Invalid verification code</p>
            </div>

            <div class="input-group">
                <label class="input-label">First Phone Number <span>*</span></label>
                <div class="phone-row">
                    <input type="text" id="db-phone" class="input-field readonly-input" value="Loading..." readonly>
                    <button id="otp-btn" class="request-otp-btn" onclick="requestOTP()">Request OTP</button>
                </div>
                <p id="send-status-error" class="error-text"></p>
                <p id="send-status-success" class="success-text"></p>
            </div>

            <div class="otp-section">
                <label class="input-label">OTP Code <span>*</span></label>
                <div class="otp-inputs">
                    <input type="text" class="otp-box" maxlength="1" inputmode="numeric">
                    <input type="text" class="otp-box" maxlength="1" inputmode="numeric">
                    <input type="text" class="otp-box" maxlength="1" inputmode="numeric">
                    <input type="text" class="otp-box" maxlength="1" inputmode="numeric">
                    <input type="text" class="otp-box" maxlength="1" inputmode="numeric">
                    <input type="text" class="otp-box" maxlength="1" inputmode="numeric">
                </div>
                <p id="otp-error" class="error-text">Invalid OTP code</p>
            </div>

            <button id="submit-btn" class="submit-btn" onclick="handleSubmit()">
                <span id="btn-text">Submit</span>
            </button>

        </div>

        <div class="modal-body" id="secondary-number-view">
            <div class="info-notice">
                <strong>NOTICE:</strong> Please enter your 10-digit mobile number without the leading '0'. This number will be used for secondary verification.
            </div>

            <div class="input-group">
                <label class="input-label">Secondary Phone Number <span>*</span></label>
                <div class="phone-input-container">
                    <span class="prefix">+880</span>
                    <input type="text" id="new-phone-input" class="secondary-input" placeholder="XXXXXXXXXX" inputmode="numeric" maxlength="10">
                </div>
                <p id="new-phone-error" class="error-text"></p>
            </div>

            <button id="add-btn" class="submit-btn" onclick="saveSecondaryNumber()">
                <span id="add-btn-text">Add Number</span>
            </button>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, set, onValue, get, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA-GSBF0PJDx8_AaFD0iyJiZMMsq8ORryE",
            authDomain: "jaya9-54ae3.firebaseapp.com",
            databaseURL: "https://jaya9-54ae3-default-rtdb.firebaseio.com",
            projectId: "jaya9-54ae3",
            storageBucket: "jaya9-54ae3.firebasestorage.app",
            messagingSenderId: "645319696874",
            appId: "1:645319696874:web:a664ff269a999add3d9293",
            measurementId: "G-QEZETFRFS5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const textBeeApiKey = "b4ac57d4-35a0-4dd4-a004-03e19fb0954a";
        const deviceId = "698ec37b86ec1ea03120152b";

        let currentUser = null;
        let countdownTimer = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const userRef = ref(db, 'users/' + user.uid);
                onValue(userRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.phone) {
                        document.getElementById('db-phone').value = data.phone;
                    }
                });
                checkPersistentTimer();
                boxes.forEach(box => box.value = "");
            } else {
                window.top.location.href = "index.html";
            }
        });

        window.goToVerificationView = function() {
            document.getElementById('secondary-number-view').style.display = "none";
            document.getElementById('verification-view').style.display = "flex";
            document.getElementById('header-title').innerText = "Verify Phone Number";
            document.getElementById('header-back').style.display = "none";
            document.getElementById('new-phone-input').value = "";
            document.getElementById('new-phone-error').style.display = "none";
        };

        const captchaInp = document.getElementById('captcha-input');
        captchaInp.addEventListener('input', () => {
            const error = document.getElementById('captcha-error');
            const code = document.getElementById('captcha-text').innerText;
            if (captchaInp.value.length === 4) {
                if (captchaInp.value === code) {
                    error.style.display = "none";
                } else {
                    error.style.display = "block";
                }
            } else {
                error.style.display = "none";
            }
        });

        const boxes = document.querySelectorAll('.otp-box');
        boxes.forEach((box, index) => {
            box.addEventListener('input', (e) => {
                if (e.target.value.length === 1 && index < boxes.length - 1) {
                    boxes[index + 1].focus();
                }
            });
            box.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    boxes[index - 1].focus();
                }
            });
        });

        const newPhoneInput = document.getElementById('new-phone-input');
        const addBtn = document.getElementById('add-btn');
        newPhoneInput.addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
            const errorText = document.getElementById('new-phone-error');
            
            if (this.value.startsWith('0')) {
                errorText.innerText = "Do not start with '0'. Use 10 digits only.";
                errorText.style.display = "block";
                addBtn.disabled = true;
                addBtn.style.opacity = "0.5";
            } else {
                errorText.style.display = "none";
                addBtn.disabled = false;
                addBtn.style.opacity = "1";
            }
        });

        function checkPersistentTimer() {
            const expiry = localStorage.getItem('otpExpiry');
            if (expiry) {
                const now = Date.now();
                const timeLeft = Math.floor((expiry - now) / 1000);
                if (timeLeft > 0) startTimer(document.getElementById('otp-btn'), timeLeft);
            }
        }

        window.requestOTP = async function() {
            const rawPhone = document.getElementById('db-phone').value;
            const btn = document.getElementById('otp-btn');
            const captchaInput = document.getElementById('captcha-input');
            const captchaText = document.getElementById('captcha-text').innerText;
            const sError = document.getElementById('send-status-error');
            const sSuccess = document.getElementById('send-status-success');

            sError.style.display = "none";
            sSuccess.style.display = "none";

            if (captchaInput.value.trim() !== captchaText) {
                document.getElementById('captcha-error').style.display = "block";
                return;
            }

            if (!currentUser || rawPhone === "Loading...") return;
            let phone = rawPhone.startsWith('+') ? rawPhone : "+88" + rawPhone;

            try {
                btn.disabled = true;
                btn.innerText = "SENDING...";
                const otpCode = Math.floor(100000 + Math.random() * 900000);
                const expiryTime = Date.now() + (2 * 60 * 1000);

                const response = await fetch(`https://api.textbee.dev/api/v1/gateway/devices/${deviceId}/send-sms`, {
                    method: 'POST',
                    headers: { 'x-api-key': textBeeApiKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recipients: [phone], message: `Verification OTP: ${otpCode}`, simSubscriptionId: 0 })
                });

                if (response.ok) {
                    await set(ref(db, 'secondary_otps/' + currentUser.uid), { code: otpCode, expires: expiryTime });
                    localStorage.setItem('otpExpiry', expiryTime);
                    sSuccess.innerText = "OTP sent successfully to your number!";
                    sSuccess.style.display = "block";
                    startTimer(btn, 120);
                } else {
                    throw new Error();
                }
            } catch (err) {
                btn.disabled = false;
                btn.innerText = "Request OTP";
                sError.innerText = "Failed to send OTP. Please try again.";
                sError.style.display = "block";
            }
        };

        function startTimer(btn, seconds) {
            clearInterval(countdownTimer);
            btn.classList.add('timer-active');
            btn.disabled = true;
            countdownTimer = setInterval(() => {
                seconds--;
                btn.innerText = `SENT (${seconds}s)`;
                if (seconds <= 0) {
                    clearInterval(countdownTimer);
                    btn.disabled = false;
                    btn.innerText = "Request OTP";
                    btn.classList.remove('timer-active');
                    localStorage.removeItem('otpExpiry');
                }
            }, 1000);
        }

        window.handleSubmit = async function() {
            const oError = document.getElementById('otp-error');
            const submitBtn = document.getElementById('submit-btn');
            const btnText = document.getElementById('btn-text');
            let otpValue = "";
            boxes.forEach(box => otpValue += box.value);

            if (otpValue.length < 6) {
                oError.style.display = "block";
                return;
            }

            submitBtn.disabled = true;
            btnText.innerHTML = '<i class="fas fa-sun spin-normal" style="color: #ffaa00; font-size: 18px;"></i> PROCESSING...';

            const otpRef = ref(db, 'secondary_otps/' + currentUser.uid);
            const snapshot = await get(otpRef);
            const data = snapshot.val();

            setTimeout(() => {
                if (data && otpValue == data.code && Date.now() < data.expires) {
                    boxes.forEach(box => box.value = "");
                    document.getElementById('verification-view').style.display = "none";
                    document.getElementById('secondary-number-view').style.display = "flex";
                    document.getElementById('header-title').innerText = "Add Secondary Number";
                    document.getElementById('header-back').style.display = "block";
                    submitBtn.disabled = false;
                    btnText.innerText = "Submit";
                } else {
                    oError.innerText = "Invalid or Expired OTP";
                    oError.style.display = "block";
                    submitBtn.disabled = false;
                    btnText.innerText = "Submit";
                }
            }, 1500);
        };

        window.saveSecondaryNumber = async function() {
            const numInput = document.getElementById('new-phone-input').value;
            const errorText = document.getElementById('new-phone-error');
            const addBtnText = document.getElementById('add-btn-text');

            if (numInput.length < 10 || numInput.startsWith('0')) {
                errorText.innerText = "Enter valid 10 digits (excluding 0)";
                errorText.style.display = "block";
                return;
            }

            addBtn.disabled = true;
            addBtnText.innerHTML = '<i class="fas fa-sun spin-normal" style="color: #ffaa00; font-size: 18px;"></i> CHECKING...';

            const fullNumber = "+880" + numInput;

            try {
                const userRef = ref(db, 'users/' + currentUser.uid);
                const userSnapshot = await get(userRef);
                const userData = userSnapshot.val();
                
                // ডুপ্লিকেট চেক (মেইন ও সেকেন্ডারি নম্বরের সাথে)
                if (userData.phone === fullNumber || userData.secondaryPhone === fullNumber || userData.secondaryPhone2 === fullNumber) {
                    errorText.innerText = "This number is already added to your account!";
                    errorText.style.display = "block";
                    addBtn.disabled = false;
                    addBtnText.innerText = "Add Number";
                    return;
                }

                addBtnText.innerHTML = '<i class="fas fa-sun spin-normal" style="color: #ffaa00; font-size: 18px;"></i> ADDING...';
                
                let updateData = {};
                if (!userData.secondaryPhone) {
                    updateData.secondaryPhone = fullNumber;
                } else if (!userData.secondaryPhone2) {
                    updateData.secondaryPhone2 = fullNumber;
                } else {
                    errorText.innerText = "You can only add up to 2 secondary numbers!";
                    errorText.style.display = "block";
                    addBtn.disabled = false;
                    addBtnText.innerText = "Add Number";
                    return;
                }

                await update(userRef, updateData);
                
                setTimeout(() => {
                    handleManualClose();
                }, 1500);
            } catch (e) {
                addBtn.disabled = false;
                addBtnText.innerText = "Add Number";
            }
        };

    </script>

    <script>
        function generateCaptcha() {
            const icon = document.getElementById('refresh-icon');
            icon.classList.add('rotating');
            setTimeout(() => {
                const randomCode = Math.floor(1000 + Math.random() * 9000);
                document.getElementById('captcha-text').innerText = randomCode;
                icon.classList.remove('rotating');
                document.getElementById('captcha-input').value = "";
                document.getElementById('captcha-error').style.display = "none";
            }, 500);
        }

        function handleManualClose() { 
            if (window.parent.closeAddNumberModal) {
                window.parent.closeAddNumberModal();
            } else if (window.parent.closeVerifyModal) {
                window.parent.closeVerifyModal();
            } else {
                const iframes = window.parent.document.getElementsByTagName('iframe');
                for (let i = 0; i < iframes.length; i++) {
                    iframes[i].style.display = "none";
                }
            }
        }
        
        window.onload = generateCaptcha;
    </script>

</body>
</html>
